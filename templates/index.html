{% extends "base.html" %}
{% block title %}Deals Dashboard â€” Wishlist Tracker{% endblock %}

{% block extra_head %}
<style>
  /* â”€â”€ FILTER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .filter-bar .search-wrap {
    position: relative;
    flex: 1;
    min-width: 200px;
    max-width: 340px;
  }

  .filter-bar .search-wrap input { padding-left: 36px; }

  .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 0.8rem;
    pointer-events: none;
  }

  .filter-toggle {
    background: var(--surface2);
    border: 1px solid var(--border2);
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .filter-toggle:hover, .filter-toggle.active {
    border-color: var(--green);
    color: var(--green);
  }

  /* â”€â”€ DEAL ROWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .game-thumb {
    width: 40px;
    height: 28px;
    border-radius: 4px;
    object-fit: cover;
    display: block;
    background: var(--surface2);
    border: 1px solid var(--border);
  }

  .game-title-link {
    color: var(--text);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.82rem;
    transition: color 0.15s;
    display: block;
    line-height: 1.3;
  }
  .game-title-link:hover { color: var(--green); }

  .store-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.68rem;
    color: var(--text-dim);
  }

  .price-best {
    font-family: var(--font-display);
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--text);
  }

  .price-best.at-low { color: var(--green); }

  .historic-low {
    font-size: 0.68rem;
    color: var(--text-muted);
  }

  .bundle-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.68rem;
    color: var(--purple);
    border: 1px solid rgba(168,85,247,0.3);
    background: rgba(168,85,247,0.07);
    border-radius: 4px;
    padding: 2px 7px;
  }

  .at-historic-low-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 0.62rem;
    color: var(--green);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .col-thumb    { width: 56px; }
  .col-title    { min-width: 160px; }
  .col-store    { width: 130px; }
  .col-price    { width: 100px; text-align: right; }
  .col-disc     { width: 100px; text-align: center; }
  .col-hist     { width: 110px; text-align: right; }
  .col-bundles  { width: 90px;  text-align: center; }
  .col-actions  { width: 48px;  text-align: center; }

  /* Result count */
  .result-count {
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-left: auto;
  }
</style>
{% endblock %}

{% block content %}
<!-- Stats bar (populated via JS) -->
<div class="stats-bar" id="stats-bar">
  <div class="stat-chip">
    <span class="label">Games</span>
    <span class="value" id="stat-games">â€”</span>
  </div>
  <div class="stat-chip accent-green">
    <span class="label">On Sale</span>
    <span class="value" id="stat-sale">â€”</span>
  </div>
  <div class="stat-chip accent-amber">
    <span class="label">Prices Tracked</span>
    <span class="value" id="stat-prices">â€”</span>
  </div>
  <div class="stat-chip">
    <span class="label">Bundles Found</span>
    <span class="value" id="stat-bundles">â€”</span>
  </div>
</div>

<!-- Controls -->
<div class="section-head">
  <h2 class="section-title">All Deals</h2>
  <a href="/settings" class="btn btn-primary">âŸ³ Sync Wishlist</a>
</div>

<div class="filter-bar">
  <div class="search-wrap">
    <span class="search-icon">âŒ•</span>
    <input type="search" id="search-input" placeholder="Search games..." autocomplete="off">
  </div>
  
  <!-- Filter buttons -->
  <button class="filter-toggle" id="filter-sale" data-filter="sale">On Sale</button>
  <button class="filter-toggle" id="filter-50" data-filter="50">50%+ Off</button>
  <button class="filter-toggle" id="filter-75" data-filter="75">75%+ Off</button>
  <button class="filter-toggle" id="filter-bundle" data-filter="bundle">Has Bundle</button>
  
  <!-- Sort buttons -->
  <div style="display:flex; gap:4px; align-items:center; border-left:1px solid var(--border2); padding-left:12px; margin-left:8px;">
    <span style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-dim); font-weight:500;">Sort:</span>
    <button class="filter-toggle active" id="sort-discount" data-sort="discount">Discount</button>
    <button class="filter-toggle" id="sort-price" data-sort="price">Price</button>
    <button class="filter-toggle" id="sort-name" data-sort="name">Name</button>
  </div>
  
  <div style="position:relative;">
    <button class="filter-toggle" id="exclude-stores-btn" style="min-width:140px;">
      Exclude Stores <span id="exclude-count" style="opacity:0.6;"></span>
    </button>
    <div id="store-dropdown" style="display:none; position:absolute; top:100%; left:0; margin-top:4px; background:var(--surface2); border:1px solid var(--border2); border-radius:6px; padding:8px; min-width:200px; z-index:100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
      <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-dim); margin-bottom:8px; padding:0 4px;">Hide stores:</div>
      <div id="store-checkboxes" style="max-height:240px; overflow-y:auto;"></div>
    </div>
  </div>
  
  <div style="position:relative;">
    <button class="filter-toggle" id="drm-filter-btn" style="min-width:140px;">
      DRM Filter <span id="drm-count" style="opacity:0.6;"></span>
    </button>
    <div id="drm-dropdown" style="display:none; position:absolute; top:100%; left:0; margin-top:4px; background:var(--surface2); border:1px solid var(--border2); border-radius:6px; padding:8px; min-width:200px; z-index:100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
      <div style="font-size:0.65rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--text-dim); margin-bottom:8px; padding:0 4px;">Require DRM:</div>
      <div id="drm-checkboxes" style="max-height:240px; overflow-y:auto;"></div>
    </div>
  </div>
  
  <span class="result-count" id="result-count"></span>
</div>

<!-- Deals table -->
<div class="card">
  <div style="overflow-x:auto;">
    <table class="data-table" id="deals-table">
      <thead>
        <tr>
          <th class="col-thumb"></th>
          <th class="col-title">Game</th>
          <th class="col-store">Best Store</th>
          <th class="col-price">Best Price</th>
          <th class="col-disc">Discount</th>
          <th class="col-hist">Historic Low</th>
          <th class="col-bundles">Bundles</th>
          <th class="col-actions"></th>
        </tr>
      </thead>
      <tbody id="deals-body">
        <tr>
          <td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);">
            <span class="spinner"></span>
            <span style="margin-left:10px;">Loading deals...</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty state (hidden until needed) -->
  <div class="empty-state" id="empty-state" style="display:none;">
    <div class="icon">ðŸŽ®</div>
    <h3>No games yet</h3>
    <p>Sync your Steam wishlist to start tracking prices across stores.</p>
    <a href="/settings" class="btn btn-primary">Set up Sync</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allGames = [];
let activeFilters = new Set();
let excludedStores = new Set();
let allStores = new Set();
let requiredDRM = new Set();  // DRM requirements to filter by
let allDRM = new Set();       // All unique DRM found
let sortBy = "discount";  // "name", "price", or "discount"

// â”€â”€ Load & render deals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDeals() {
  try {
    // Fetch all games with ALL their prices (not just best)
    const res  = await fetch("/api/games/with-prices");
    allGames   = await res.json();
    
    // Extract unique stores from all prices
    allStores.clear();
    allDRM.clear();
    allGames.forEach(g => {
      (g.prices || []).forEach(p => {
        if (p.store && !p.store.startsWith("Historic Low")) {
          allStores.add(p.store);
        }
        // Extract DRM from each price
        if (p.drm) {
          p.drm.split(",").forEach(d => allDRM.add(d.trim()));
        }
      });
    });
    populateStoreDropdown();
    populateDRMDropdown();
    
    renderTable(allGames);

    // Stats
    const s = await (await fetch("/api/stats")).json();
    document.getElementById("stat-games").textContent   = s.total_games;
    document.getElementById("stat-sale").textContent    = s.on_sale;
    document.getElementById("stat-prices").textContent  = s.total_prices;
    document.getElementById("stat-bundles").textContent = s.total_bundles;
  } catch (e) {
    console.error(e);
  }
}

function applyFilters() {
  const q = document.getElementById("search-input").value.toLowerCase().trim();
  let rows = [...allGames];

  // Text search
  if (q) rows = rows.filter(r => r.title.toLowerCase().includes(q));

  // Compute best price for each row (factoring in excluded stores)
  rows = rows.map(g => {
    const availablePrices = (g.prices || [])
      .filter(p => p && p.store && !excludedStores.has(p.store) && p.price_current != null);
    if (availablePrices.length > 0) {
      const best = availablePrices.reduce((a, b) => {
        const priceA = parseFloat(a.price_current);
        const priceB = parseFloat(b.price_current);
        if (isNaN(priceA)) return b;
        if (isNaN(priceB)) return a;
        return priceA < priceB ? a : b;
      });
      return {
        ...g,
        _computed_best_price: best.price_current,
        _computed_best_discount: best.discount_pct || 0,
      };
    }
    return {...g, _computed_best_price: null, _computed_best_discount: 0};
  });

  // Active toggle filters (use computed values)
  if (activeFilters.has("sale"))   rows = rows.filter(r => r._computed_best_discount > 0);
  if (activeFilters.has("50"))     rows = rows.filter(r => r._computed_best_discount >= 50);
  if (activeFilters.has("75"))     rows = rows.filter(r => r._computed_best_discount >= 75);
  if (activeFilters.has("bundle")) rows = rows.filter(r => (r.num_bundles || 0) > 0);

  // DRM filter - only show games where at least one price has all required DRM
  if (requiredDRM.size > 0) {
    rows = rows.filter(g => {
      return (g.prices || []).some(p => {
        if (!p.drm) return false;
        const gameDRM = new Set(p.drm.split(",").map(d => d.trim()));
        // Check if all required DRM are in this price's DRM
        return Array.from(requiredDRM).every(required => gameDRM.has(required));
      });
    });
  }

  // Sort based on selected sort method
  rows.sort((a, b) => {
    switch(sortBy) {
      case "name":
        // Sort alphabetically by title
        return a.title.localeCompare(b.title);
      
      case "price":
        // Sort by lowest price
        const priceA = a._computed_best_price || Infinity;
        const priceB = b._computed_best_price || Infinity;
        return priceA - priceB;
      
      case "discount":
      default:
        // Sort by highest discount, then lowest price
        const discA = a._computed_best_discount || 0;
        const discB = b._computed_best_discount || 0;
        if (discA !== discB) return discB - discA;
        
        const priceA2 = a._computed_best_price || Infinity;
        const priceB2 = b._computed_best_price || Infinity;
        return priceA2 - priceB2;
    }
  });

  renderTable(rows);
}

function renderTable(games) {
  const tbody  = document.getElementById("deals-body");
  const empty  = document.getElementById("empty-state");
  const countEl = document.getElementById("result-count");

  countEl.textContent = `${games.length} game${games.length !== 1 ? 's' : ''}`;

  if (games.length === 0) {
    tbody.innerHTML = "";
    empty.style.display = allGames.length === 0 ? "block" : "none";

    if (allGames.length > 0) {
      // Filtered empty
      tbody.innerHTML = `
        <tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted);">
          No games match your filters
        </td></tr>`;
    }
    return;
  }

  empty.style.display = "none";

  tbody.innerHTML = games.map(g => {
    // Compute best price from non-excluded stores
    const availablePrices = (g.prices || [])
      .filter(p => p && p.store && !excludedStores.has(p.store) && p.price_current != null);
    
    let bestPrice = null;
    let bestStore = "â€”";
    let bestUrl = "#";
    let bestDiscount = 0;
    let currency = "GBP";
    
    if (availablePrices.length > 0) {
      const best = availablePrices.reduce((a, b) => {
        const priceA = parseFloat(a.price_current);
        const priceB = parseFloat(b.price_current);
        if (isNaN(priceA)) return b;
        if (isNaN(priceB)) return a;
        return priceA < priceB ? a : b;
      });
      bestPrice = best.price_current;
      bestStore = best.store || "â€”";
      bestUrl = best.url || "#";
      bestDiscount = best.discount_pct || 0;
      currency = best.currency || "GBP";
    }
    
    const atLow    = bestPrice && g.historic_low && bestPrice <= g.historic_low * 1.05;
    const priceStr = bestPrice !== null ? `Â£${Number(bestPrice).toFixed(2)}` : "â€”";
    const histStr  = g.historic_low !== null ? `Â£${Number(g.historic_low).toFixed(2)}` : "â€”";
    const thumb    = g.header_image
      ? `<img class="game-thumb" src="${g.header_image}" alt="" loading="lazy">`
      : `<div class="game-thumb"></div>`;

    const discBadge = fmtDiscount(bestDiscount);
    const bundleBadge = g.num_bundles > 0
      ? `<span class="bundle-chip">â¬¡ ${g.num_bundles}</span>`
      : `<span style="color:var(--text-muted)">â€”</span>`;

    const lowBadge = atLow
      ? `<div class="at-historic-low-badge">â˜… historic low</div>`
      : "";

    const storeName = bestStore;
    const storeUrl  = bestUrl;
    const isReference = storeName && storeName.startsWith("Reference Price");
    
    // Build query string for excluded stores and DRM filters
    const queryParts = [];
    if (excludedStores.size > 0) {
      queryParts.push(`exclude=${Array.from(excludedStores).map(encodeURIComponent).join(',')}`);
    }
    if (requiredDRM.size > 0) {
      queryParts.push(`drm=${Array.from(requiredDRM).map(encodeURIComponent).join(',')}`);
    }
    const queryString = queryParts.length > 0 ? `?${queryParts.join('&')}` : '';
    
    return `
      <tr${isReference ? ' style="opacity:0.6;"' : ''}>
        <td class="col-thumb">${thumb}</td>
        <td class="col-title">
          <a href="/game/${g.app_id}${queryString}" class="game-title-link">${escHtml(g.title)}</a>
          ${lowBadge}
          ${isReference ? '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px;">âš  No current prices available</div>' : ''}
        </td>
        <td class="col-store">
          ${isReference 
            ? `<span class="store-chip" style="opacity:0.7;cursor:default;" title="Historic low price - not currently available">${escHtml(storeName)}</span>`
            : `<a href="${storeUrl}" target="_blank" rel="noopener" class="store-chip">${escHtml(storeName)} â†—</a>`
          }
        </td>
        <td class="col-price">
          <span class="price-best ${atLow ? 'at-low' : ''}">${priceStr}</span>
        </td>
        <td class="col-disc">${discBadge}</td>
        <td class="col-hist">
          <span class="historic-low" title="${g.historic_low_store || ''}" style="cursor: help;">${histStr}</span>
        </td>
        <td class="col-bundles">${bundleBadge}</td>
        <td class="col-actions">
          <a href="/game/${g.app_id}${queryString}" style="color:var(--text-muted);text-decoration:none;" title="View details">â€º</a>
        </td>
      </tr>`;
  }).join("");
}

function escHtml(str) {
  const d = document.createElement("div");
  d.textContent = str;
  return d.innerHTML;
}

// â”€â”€ Filter toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".filter-toggle").forEach(btn => {
  btn.addEventListener("click", () => {
    const f = btn.dataset.filter;
    const s = btn.dataset.sort;
    
    // Handle sort buttons
    if (s) {
      sortBy = s;
      // Update active state for sort buttons
      document.querySelectorAll("[data-sort]").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      applyFilters();
      return;
    }
    
    // Handle filter buttons
    if (activeFilters.has(f)) {
      activeFilters.delete(f);
      btn.classList.remove("active");
    } else {
      activeFilters.add(f);
      btn.classList.add("active");
    }
    applyFilters();
  });
});

document.getElementById("search-input").addEventListener("input", applyFilters);

function populateStoreDropdown() {
  const container = document.getElementById("store-checkboxes");
  const sorted = Array.from(allStores).sort();
  
  container.innerHTML = sorted.map(store => `
    <label style="display:flex; align-items:center; gap:8px; padding:6px 4px; cursor:pointer; font-size:0.75rem; color:var(--text); border-radius:4px;" 
           onmouseover="this.style.background='rgba(255,255,255,0.05)'" 
           onmouseout="this.style.background='transparent'">
      <input type="checkbox" data-store="${escHtml(store)}" style="cursor:pointer;">
      <span>${escHtml(store)}</span>
    </label>
  `).join('');
  
  // Add event listeners
  container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const store = e.target.dataset.store;
      if (e.target.checked) {
        excludedStores.add(store);
      } else {
        excludedStores.delete(store);
      }
      updateExcludeCount();
      applyFilters();
    });
  });
}

function updateExcludeCount() {
  const count = excludedStores.size;
  const countEl = document.getElementById("exclude-count");
  countEl.textContent = count > 0 ? `(${count})` : '';
}

function populateDRMDropdown() {
  const container = document.getElementById("drm-checkboxes");
  const sorted = Array.from(allDRM).sort();
  
  container.innerHTML = sorted.map(drm => `
    <label style="display:flex; align-items:center; gap:8px; padding:6px 4px; cursor:pointer; font-size:0.75rem; color:var(--text); border-radius:4px;" 
           onmouseover="this.style.background='rgba(255,255,255,0.05)'" 
           onmouseout="this.style.background='transparent'">
      <input type="checkbox" data-drm="${escHtml(drm)}" style="cursor:pointer;">
      <span>${escHtml(drm || "None")}</span>
    </label>
  `).join('');
  
  // Add event listeners
  container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const drm = e.target.dataset.drm;
      if (e.target.checked) {
        requiredDRM.add(drm);
      } else {
        requiredDRM.delete(drm);
      }
      updateDRMCount();
      applyFilters();
    });
  });
}

function updateDRMCount() {
  const count = requiredDRM.size;
  const countEl = document.getElementById("drm-count");
  countEl.textContent = count > 0 ? `(${count})` : '';
}

// Dropdown toggle
document.addEventListener('click', (e) => {
  const storeBtn = document.getElementById('exclude-stores-btn');
  const storeDropdown = document.getElementById('store-dropdown');
  const drmBtn = document.getElementById('drm-filter-btn');
  const drmDropdown = document.getElementById('drm-dropdown');
  
  if (storeBtn && storeBtn.contains(e.target)) {
    storeDropdown.style.display = storeDropdown.style.display === 'none' ? 'block' : 'none';
    drmDropdown.style.display = 'none';
  } else if (storeDropdown && !storeDropdown.contains(e.target)) {
    storeDropdown.style.display = 'none';
  }
  
  if (drmBtn && drmBtn.contains(e.target)) {
    drmDropdown.style.display = drmDropdown.style.display === 'none' ? 'block' : 'none';
    storeDropdown.style.display = 'none';
  } else if (drmDropdown && !drmDropdown.contains(e.target)) {
    drmDropdown.style.display = 'none';
  }
});

document.addEventListener("DOMContentLoaded", loadDeals);
</script>
{% endblock %}
