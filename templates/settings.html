{% extends "base.html" %}
{% block title %}Sync Settings ‚Äî Wishlist Tracker{% endblock %}

{% block extra_head %}
<style>
  .settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    max-width: 900px;
  }

  @media (max-width: 720px) { .settings-grid { grid-template-columns: 1fr; } }

  .form-group { margin-bottom: 18px; }

  .form-label {
    display: block;
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    margin-bottom: 7px;
  }

  .form-hint {
    font-size: 0.68rem;
    color: var(--text-muted);
    margin-top: 5px;
    line-height: 1.5;
  }

  .form-hint a { color: var(--blue); text-decoration: none; }
  .form-hint a:hover { text-decoration: underline; }

  .card-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
  }

  .card-body { padding: 20px 18px; }

  .toggle-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
  }

  .toggle {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
  }

  .toggle input { opacity: 0; width: 0; height: 0; }

  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--border2);
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .toggle-slider::after {
    content: '';
    position: absolute;
    left: 3px;
    top: 3px;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .toggle input:checked + .toggle-slider { background: var(--green); }
  .toggle input:checked + .toggle-slider::after { transform: translateX(16px); }

  .toggle-label { font-size: 0.78rem; color: var(--text); }

  /* Sync log */
  .sync-log {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px 14px;
    font-size: 0.72rem;
    color: var(--text-dim);
    font-family: var(--font-mono);
    min-height: 80px;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
    display: none;
    margin-top: 16px;
  }

  .sync-log.visible { display: block; }

  /* Key links */
  .key-links {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 16px;
  }

  .key-link {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    text-decoration: none;
    color: var(--text);
    font-size: 0.75rem;
    transition: border-color 0.15s;
  }

  .key-link:hover { border-color: var(--blue); color: var(--blue); }

  .key-link .icon { font-size: 1rem; }
</style>
{% endblock %}

{% block content %}
<h1 style="font-family:var(--font-display);font-size:1.6rem;font-weight:800;margin-bottom:8px;">Sync Settings</h1>
<p style="color:var(--text-dim);font-size:0.78rem;margin-bottom:28px;">
  Enter your API keys once to fetch your Steam wishlist and compare prices. Keys are never stored by this app ‚Äî only used for sync calls.
</p>

<div class="settings-grid">

  <!-- Credentials card -->
  <div class="card" style="grid-column: 1 / -1;">
    <div class="card-header">API Keys & Steam ID</div>
    <div class="card-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div>
          <div class="form-group">
            <label class="form-label" for="steam-id">Steam ID64</label>
            <input type="text" id="steam-id" placeholder="76561198000000000" autocomplete="off">
            <div class="form-hint">
              Your 17-digit Steam ID. Find it at
              <a href="https://www.steamidfinder.com" target="_blank">steamidfinder.com</a>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="steam-key">Steam API Key</label>
            <input type="password" id="steam-key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="form-hint">
              Get yours at <a href="https://steamcommunity.com/dev/apikey" target="_blank">steamcommunity.com/dev/apikey</a>
            </div>
          </div>
        </div>
        <div>
          <div class="form-group">
            <label class="form-label" for="itad-key">ITAD API Key <span style="color:var(--text-muted)">(optional)</span></label>
            <input type="password" id="itad-key" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <div class="form-hint">
              Free key at <a href="https://isthereanydeal.com/apps/my/" target="_blank">isthereanydeal.com/dev/app</a>.
              Enables 30+ store prices, historic lows, and bundle data.
            </div>
          </div>

        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px;">
        <button class="btn btn-primary" id="sync-btn" onclick="startSync()">
          ‚ü≥ Start Full Sync
        </button>
        <button class="btn btn-ghost" onclick="startSync(true)">
          Steam Only
        </button>
        <span id="sync-status-text" style="font-size:0.72rem;color:var(--text-dim);"></span>
      </div>

      <div class="sync-log" id="sync-log"></div>
    </div>
  </div>

  <!-- How to get keys -->
  <div class="card">
    <div class="card-header">Quick Setup Guide</div>
    <div class="card-body">
      <div style="font-size:0.78rem;color:var(--text-dim);line-height:1.8;">
        <div style="margin-bottom:12px;">
          <strong style="color:var(--text)">1. Steam Profile Privacy</strong><br>
          Your profile must be set to <em>Public</em> for the API to see your wishlist.<br>
          Steam ‚Üí Profile ‚Üí Edit Profile ‚Üí Privacy Settings ‚Üí Public.
        </div>
        <div style="margin-bottom:12px;">
          <strong style="color:var(--text)">2. Prices in GBP</strong><br>
          ITAD prices are fetched with <code>country=GB</code> so all prices display in ¬£.
        </div>
        <div>
          <strong style="color:var(--text)">3. Schedule Regular Syncs</strong><br>
          Prices change daily. Set up a cron job or Windows Task to run:<br>
          <code style="color:var(--green);font-size:0.72rem;">python main.py sync</code><br>
          (The CLI works independently of this web UI.)
        </div>
      </div>
    </div>
  </div>

  <!-- External links -->
  <div class="card">
    <div class="card-header">Get Your API Keys</div>
    <div class="card-body" style="padding-top:12px;">
      <div class="key-links">
        <a href="https://steamcommunity.com/dev/apikey" target="_blank" class="key-link">
          <span class="icon">üéÆ</span>
          <div>
            <div style="font-weight:500;">Steam API Key</div>
            <div style="font-size:0.68rem;color:var(--text-dim);">steamcommunity.com/dev/apikey</div>
          </div>
        </a>
        <a href="https://www.steamidfinder.com" target="_blank" class="key-link">
          <span class="icon">üîç</span>
          <div>
            <div style="font-weight:500;">Find Your Steam ID64</div>
            <div style="font-size:0.68rem;color:var(--text-dim);">steamidfinder.com</div>
          </div>
        </a>
        <a href="https://isthereanydeal.com/apps/my/" target="_blank" class="key-link">
          <span class="icon">üí∞</span>
          <div>
            <div style="font-weight:500;">ITAD API Key (free)</div>
            <div style="font-size:0.68rem;color:var(--text-dim);">isthereanydeal.com/dev/app</div>
          </div>
        </a>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// Restore saved keys from sessionStorage (not localStorage ‚Äî keys shouldn't persist across sessions)
['steam-id','steam-key','itad-key'].forEach(id => {
  const saved = sessionStorage.getItem(id);
  if (saved) document.getElementById(id).value = saved;
});

// Save on input so keys survive page navigation within session
['steam-id','steam-key','itad-key'].forEach(id => {
  document.getElementById(id).addEventListener('input', e => {
    sessionStorage.setItem(id, e.target.value);
  });
});

async function startSync(steamOnly = false) {
  const steamId  = document.getElementById("steam-id").value.trim();
  const steamKey = document.getElementById("steam-key").value.trim();
  const itadKey  = document.getElementById("itad-key").value.trim();

  if (!steamId || !steamKey) {
    showToast("Steam ID and API key are required", "error");
    return;
  }

  const btn = document.getElementById("sync-btn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Syncing...';

  const log = document.getElementById("sync-log");
  log.textContent = "Starting sync...\n";
  log.classList.add("visible");

  try {
    const res = await fetch("/api/sync/full", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        steam_id:    steamId,
        steam_key:   steamKey,
        itad_key:    itadKey,
      }),
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || "Sync failed");
    }

    // Start polling for status
    startSyncPoll();

    // Poll and update log display
    const pollLog = setInterval(async () => {
      const s = await (await fetch("/api/sync/status")).json();
      log.textContent = `Step: ${s.step || "‚Äî"}\n${s.error ? "Error: " + s.error : ""}`;

      if (!s.running && s.done) {
        clearInterval(pollLog);
        btn.disabled = false;
        btn.innerHTML = "‚ü≥ Start Full Sync";

        if (s.error) {
          log.textContent += "\n\nSync failed. See terminal for full error.";
        } else {
          log.textContent += "\nSync complete! ‚úì";
        }
      }
    }, 1500);

  } catch (e) {
    showToast(e.message, "error");
    btn.disabled = false;
    btn.innerHTML = "‚ü≥ Start Full Sync";
    log.textContent += "Error: " + e.message;
  }
}
</script>
{% endblock %}
