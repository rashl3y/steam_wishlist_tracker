{% extends "base.html" %}
{% block title %}{{ game.title }} â€” Wishlist Tracker{% endblock %}

{% block extra_head %}
<style>
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--text-dim);
    text-decoration: none;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 24px;
    transition: color 0.15s;
  }
  .back-link:hover { color: var(--text); }

  /* â”€â”€ HERO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .game-hero {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 28px;
    align-items: start;
    margin-bottom: 36px;
  }

  .hero-art {
    width: 280px;
    border-radius: 10px;
    border: 1px solid var(--border);
    aspect-ratio: 2/1;
    object-fit: cover;
    background: var(--surface2);
  }

  .hero-info { padding-top: 4px; }

  .hero-title {
    font-family: var(--font-display);
    font-size: 2rem;
    font-weight: 800;
    line-height: 1.1;
    letter-spacing: -0.02em;
    margin-bottom: 12px;
  }

  .hero-meta {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    align-items: center;
  }

  .hero-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }

  /* â”€â”€ BEST PRICE HIGHLIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .best-price-card {
    display: inline-flex;
    flex-direction: column;
    background: rgba(0,229,160,0.07);
    border: 1px solid var(--green-dim);
    border-radius: 10px;
    padding: 16px 24px;
    margin-top: 12px;
  }

  .best-price-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--green-dim);
    margin-bottom: 4px;
  }

  .best-price-value {
    font-family: var(--font-display);
    font-size: 2.6rem;
    font-weight: 800;
    color: var(--green);
    line-height: 1;
    letter-spacing: -0.03em;
  }

  .best-price-store { font-size: 0.72rem; color: var(--text-dim); margin-top: 6px; }

  /* â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  @media (max-width: 900px) { .detail-grid { grid-template-columns: 1fr; } }

  .card-header {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-dim);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* â”€â”€ PRICES TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .price-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 18px;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  .price-row:last-child { border-bottom: none; }
  .price-row:hover { background: rgba(255,255,255,0.02); }

  .price-row .store-name { font-size: 0.8rem; color: var(--text); }
  .price-row .price-amt  {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 700;
  }
  .price-row .price-amt.best { color: var(--green); }
  .price-row .regular-price  { font-size: 0.68rem; color: var(--text-muted); text-decoration: line-through; }

  /* â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chart-container {
    padding: 20px 18px;
    height: 240px;
    position: relative;
  }

  canvas#history-chart {
    width: 100% !important;
    height: 100% !important;
  }

  /* â”€â”€ BUNDLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .bundle-row {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
  }
  .bundle-row:last-child { border-bottom: none; }
  .bundle-title { font-size: 0.82rem; color: var(--text); margin-bottom: 4px; }
  .bundle-meta  { font-size: 0.68rem; color: var(--text-dim); display: flex; gap: 12px; }

  /* â”€â”€ NO DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .no-data {
    padding: 32px 18px;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.75rem;
  }
</style>
{% endblock %}

{% block content %}
<a href="/" class="back-link">â† All Deals</a>

<!-- Filter status banner -->
<div id="filter-banner" style="display:none; background:var(--surface2); border:1px solid var(--border2); border-left:3px solid var(--amber); border-radius:8px; padding:14px 20px; margin-bottom:20px; font-size:0.78rem; color:var(--amber);">
  <span>ğŸ” Filtered stores hidden:</span> <span id="filtered-stores-list" style="font-weight:500;"></span>
</div>

<!-- Hero section (populated via JS) -->
<div class="game-hero" id="game-hero">
  <div style="width:280px;height:140px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);"></div>
  <div>
    <div style="height:32px;width:60%;background:var(--surface2);border-radius:6px;margin-bottom:12px;"></div>
    <div style="height:14px;width:40%;background:var(--surface2);border-radius:4px;"></div>
  </div>
</div>

<!-- Detail grid -->
<div class="detail-grid">

  <!-- Store prices -->
  <div class="card" id="prices-card">
    <div class="card-header">
      <span>Store Prices (GBP)</span>
      <span id="price-updated" style="color:var(--text-muted)"></span>
    </div>
    <div id="prices-list">
      <div class="no-data"><span class="spinner"></span></div>
    </div>
  </div>

  <!-- Price history chart -->
  <div class="card">
    <div class="card-header">Price History</div>
    <div class="chart-container">
      <canvas id="history-chart"></canvas>
    </div>
  </div>

</div>

<!-- Bundles (full width) -->
<div class="card" id="bundles-card">
  <div class="card-header">Bundle History</div>
  <div id="bundles-list">
    <div class="no-data"><span class="spinner"></span></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Lightweight chart library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
const APP_ID = {{ game.app_id }};

// Get excluded stores and required DRM from URL query params
function getExcludedStores() {
  const params = new URLSearchParams(window.location.search);
  const exclude = params.get('exclude');
  if (!exclude) return new Set();
  return new Set(exclude.split(',').map(s => decodeURIComponent(s)));
}

function getRequiredDRM() {
  const params = new URLSearchParams(window.location.search);
  const drm = params.get('drm');
  if (!drm) return new Set();
  return new Set(drm.split(',').map(d => decodeURIComponent(d)));
}

const excludedStores = getExcludedStores();
const requiredDRM = getRequiredDRM();

// Helper function to check if a price has required DRM
function hasDRM(price, requiredSet) {
  if (requiredSet.size === 0) return true;
  if (!price.drm) return false;
  const priceDRM = new Set(price.drm.split(",").map(d => d.trim()));
  return Array.from(requiredSet).every(required => priceDRM.has(required));
}

async function loadGameDetail() {
  const res  = await fetch(`/api/game/${APP_ID}`);
  const data = await res.json();

  // Show filter banner if stores or DRM are filtered
  if (excludedStores.size > 0 || requiredDRM.size > 0) {
    const banner = document.getElementById("filter-banner");
    const storesList = document.getElementById("filtered-stores-list");
    
    const parts = [];
    if (excludedStores.size > 0) {
      parts.push(`Excluded: ${Array.from(excludedStores).join(", ")}`);
    }
    if (requiredDRM.size > 0) {
      parts.push(`DRM Required: ${Array.from(requiredDRM).join(", ")}`);
    }
    
    storesList.textContent = parts.join(" | ");
    banner.style.display = "block";
  }

  renderHero(data.game, data.prices);
  renderPrices(data.prices);
  renderChart(data.history);
  renderBundles(data.bundles);
}

// â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHero(game, prices) {
  // Find best price (excluding filtered stores and respecting DRM requirements)
  const priced = prices.filter(p => 
    !p.store.startsWith("Historic Low") && 
    p.price_current !== null && 
    !excludedStores.has(p.store) &&
    hasDRM(p, requiredDRM)
  );
  const best   = priced.length ? priced.reduce((a, b) => a.price_current < b.price_current ? a : b) : null;

  const thumb = game.header_image
    ? `<img class="hero-art" src="${game.header_image}" alt="">`
    : `<div class="hero-art"></div>`;

  const bestPriceBlock = best ? `
    <div class="best-price-card">
      <div class="best-price-label">Best Price</div>
      <div class="best-price-value">Â£${Number(best.price_current).toFixed(2)}</div>
      <div class="best-price-store">
        ${best.discount_pct > 0 ? `<span class="badge badge-green" style="margin-right:6px">${best.discount_pct}% off</span>` : ""}
        via <a href="${best.url || '#'}" target="_blank" rel="noopener" style="color:var(--green-dim)">${escHtml(best.store)}</a>
      </div>
    </div>` : `<div style="color:var(--text-muted);margin-top:12px;font-size:0.78rem;">No prices tracked yet â€” run a sync.</div>`;

  const lastChecked = game.last_checked
    ? `<span class="badge badge-muted">Checked ${game.last_checked.slice(0,10)}</span>`
    : `<span class="badge badge-muted">Never synced</span>`;

  document.getElementById("game-hero").innerHTML = `
    ${thumb}
    <div class="hero-info">
      <h1 class="hero-title">${escHtml(game.title)}</h1>
      <div class="hero-meta">
        ${lastChecked}
        <span style="color:var(--text-muted);font-size:0.68rem;">App ID: ${game.app_id}</span>
      </div>
      ${bestPriceBlock}
      <div class="hero-actions">
        <a href="${game.steam_url || '#'}" target="_blank" class="btn btn-ghost">View on Steam â†—</a>
        <a href="/" class="btn btn-ghost">â† Back</a>
      </div>
    </div>`;
}

// â”€â”€ Prices list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPrices(prices) {
  const list = document.getElementById("prices-list");

  // Filter out "historic low" pseudo-entries, excluded stores, and DRM requirements
  const current = prices.filter(p => 
    !p.store.startsWith("Historic Low") && 
    !excludedStores.has(p.store) &&
    hasDRM(p, requiredDRM)
  );
  if (!current.length) {
    list.innerHTML = `<div class="no-data">No prices found. Try syncing.</div>`;
    return;
  }

  const sorted = [...current].sort((a, b) => a.price_current - b.price_current);
  const minPx  = sorted[0]?.price_current;

  // Updated timestamp from most recent price
  const latest = prices.reduce((a, b) =>
    (a.fetched_at || "") > (b.fetched_at || "") ? a : b, prices[0]);
  const updEl = document.getElementById("price-updated");
  if (updEl && latest?.fetched_at) updEl.textContent = latest.fetched_at.slice(0,10);

  list.innerHTML = sorted.map(p => {
    const isBest  = p.price_current === minPx;
    const discBadge = p.discount_pct > 0
      ? `<span class="badge badge-green" style="font-size:0.6rem">${p.discount_pct}% off</span>` : "";
    const regularPx = p.price_regular && p.price_regular > p.price_current
      ? `<span class="regular-price">Â£${Number(p.price_regular).toFixed(2)}</span>` : "";
    const linkOpen  = p.url ? `<a href="${p.url}" target="_blank" rel="noopener" style="text-decoration:none;color:inherit">` : "";
    const linkClose = p.url ? "</a>" : "";

    return `
      <div class="price-row">
        ${linkOpen}
          <div>
            <div class="store-name">${escHtml(p.store)}${p.url ? ' â†—' : ''}</div>
            ${regularPx}
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            ${discBadge}
            <span class="price-amt ${isBest ? 'best' : ''}">Â£${Number(p.price_current).toFixed(2)}</span>
          </div>
        ${linkClose}
      </div>`;
  }).join("");
}

// â”€â”€ Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChart(history) {
  const ctx = document.getElementById("history-chart").getContext("2d");

  if (!history || history.length === 0) {
    ctx.fillStyle = "rgba(100,116,139,0.4)";
    ctx.font = "13px 'DM Mono', monospace";
    ctx.textAlign = "center";
    ctx.fillText("No price history yet", ctx.canvas.width / 2, ctx.canvas.height / 2);
    return;
  }

  // Filter out "historic low" metadata entries for the chart AND excluded stores AND DRM
  const chartData = history.filter(h => 
    !h.store.startsWith("Historic Low") && 
    !excludedStores.has(h.store)
  );

  // Group by store so each store is a separate line
  const storeMap = {};
  chartData.forEach(h => {
    if (!storeMap[h.store]) storeMap[h.store] = [];
    storeMap[h.store].push({ x: h.recorded_at.slice(0,10), y: h.price });
  });

  const COLOURS = ["#00e5a0","#f5a623","#4f9cf9","#a855f7","#ff4757","#00b8d4"];
  const datasets = Object.entries(storeMap).map(([store, pts], i) => ({
    label:           store,
    data:            pts,
    borderColor:     COLOURS[i % COLOURS.length],
    backgroundColor: COLOURS[i % COLOURS.length] + "22",
    tension:         0.3,
    pointRadius:     3,
    fill:            false,
    borderWidth:     2,
  }));
  
  // If no data after filtering, show message
  if (datasets.length === 0) {
    ctx.fillStyle = "rgba(100,116,139,0.4)";
    ctx.font = "13px 'DM Mono', monospace";
    ctx.textAlign = "center";
    ctx.fillText("No price history for selected stores", ctx.canvas.width / 2, ctx.canvas.height / 2);
    return;
  }

  new Chart(ctx, {
    type: "line",
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: { xAxisKey: "x", yAxisKey: "y" },
      plugins: {
        legend: {
          labels: { color: "#64748b", font: { family: "'DM Mono', monospace", size: 10 }, boxWidth: 12 }
        },
        tooltip: {
          callbacks: {
            label: ctx => ` Â£${Number(ctx.parsed.y).toFixed(2)} â€” ${ctx.dataset.label}`
          }
        }
      },
      scales: {
        x: {
          type: "category",
          ticks: { color: "#64748b", font: { size: 10 }, maxTicksLimit: 8 },
          grid:  { color: "#1c2433" },
        },
        y: {
          ticks: {
            color: "#64748b",
            font: { size: 10 },
            callback: v => `Â£${v.toFixed(2)}`
          },
          grid: { color: "#1c2433" },
        }
      }
    }
  });
}

// â”€â”€ Bundles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBundles(bundles) {
  const list = document.getElementById("bundles-list");

  if (!bundles || !bundles.length) {
    list.innerHTML = `<div class="no-data">No bundle history found for this game.</div>`;
    return;
  }

  list.innerHTML = bundles.map(b => {
    const price    = b.tier_price ? `$${Number(b.tier_price).toFixed(2)} USD` : "Price N/A";
    const expires  = b.expires_at ? ` Â· Expires ${b.expires_at.slice(0,10)}` : "";
    const linkOpen  = b.bundle_url ? `<a href="${b.bundle_url}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none">` : "";
    const linkClose = b.bundle_url ? "</a>" : "";

    return `
      <div class="bundle-row">
        ${linkOpen}
          <div class="bundle-title">${escHtml(b.bundle_title)}${b.bundle_url ? ' â†—' : ''}</div>
          <div class="bundle-meta">
            <span style="color:var(--purple)">${price}</span>
            ${b.store ? `<span>${escHtml(b.store)}</span>` : ""}
            <span>Found ${(b.discovered_at || "").slice(0,10)}</span>
            ${expires ? `<span>${expires}</span>` : ""}
          </div>
        ${linkClose}
      </div>`;
  }).join("");
}

function escHtml(str) {
  const d = document.createElement("div");
  d.textContent = str || "";
  return d.innerHTML;
}

document.addEventListener("DOMContentLoaded", loadGameDetail);
</script>
{% endblock %}
